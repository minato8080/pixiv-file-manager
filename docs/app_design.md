# 画面一覧

1. **タグ取得画面**
2. **タグ検索画面**
3. **ファイル整理画面**
4. **タグ管理画面**
5. **設定画面**

# 機能詳細設計

## タグ取得画面

### タグ取得機能

1. **(画面)** フォルダ選択
   1. エクスプローラーを開いてフォルダを選択する。
2. **(APP)** フォルダ情報取得処理
   1. パラメータのフォルダ配列を再帰処理し、ファイル情報を取得する。
   2. 結果をクライアントに返却する。
3. **(画面)** 検索開始
   1. [検索]ボタン押下時、検索処理を実行する。
   2. [処理経過]ビューに処理状況を表示する。
4. **(APP)** 検索処理
   1. `ILLUST_FETCH_WORK`を TRUNCATE する。
   2. フォルダ配下の画像ファイルからファイル情報を一括取得して`ILLUST_FETCH_WORK`に INSERT する。
   3. `ILLUST_INFO`に`illust_id`がある場合、`ILLUST_FETCH_WORK`を以下条件で UPDATE する。
      1. `illust_id`,`suffix`が一致する場合、`ILLUST_FETCH_WORK.igonre_flg`を 1 にする。
      2. `illust_id`が一致し,`suffix`が一致しない場合、`ILLUST_FETCH_WORK.insert_flg`を 1 にする。
   4. `ILLUST_INFO`に`illust_id`、`suffix`がない場合、以下の優先順位で`ILLUST_FETCH_WORK.delete_flg`を 0 とし、残りを 1 に設定する。
      1. `ILLUST_FETCH_WORK.file_size`が最も小さい
      2. 上記が同じ場合、`ILLUST_FETCH_WORK.created_time`が最も古い
      3. 上記が同じ場合、列インデックスが最も小さい
   5. 一意の id を取得して配列に格納する。
   6. 配列をループして以下処理を行う。
      1. `igonre_flg`が 1 の場合、
         1. `ILLUST_INFO`から`cnum`が最小のレコードを取得する。
         2. `insert_flg`が 1 の`suffix`をインサート。
      2. `igonre_flg`が 0 の場合
         1. N 秒待機する。
         2. API 通信し、結果をパースする。
         3. 結果を取得出来た場合、情報を各テーブルに書き込む。
         4. API エラーの場合、失敗情報を配列で保持する。
      3. 処理経過を画面に通知する。
   7. ループ処理が完了したら検索したファイル数、検索に失敗したファイル数、処理時間を処理結果に格納する。
   8. タグ検索画面に DB 更新を通知する。
   9. コミットを発行し、結果をクライアントに返却する。
5. **(画面)** 削除確認
   1. 重複ファイルがある場合、削除確認ダイアログで表示する。
      1. [はい]押下時、重複削除処理を実行する。
      2. [いいえ]押下時、処理結果を表示する。
   2. 重複ファイルがない場合、処理結果を表示する。
6. **(APP)** 重複削除処理
   1. `ILLUST_FETCH_WORK.delete_flg`が 1 の実体ファイルを削除する。
   2. `ILLUST_FETCH_WORK`を TRUNCATE する。
   3. コミットを発行し、結果をクライアントに返却する。
7. **(画面)** 結果表示
   1. 処理結果を表示する。
   2. [失敗情報詳細]ボタン押下時、検索に失敗したファイルのパスを一覧表示する。

### DB 同期機能

1. **(画面)**　 DB 同期ダイアログ
   1. root が設定されていない場合、[ルートを変更する]チェックを ON にする。
   2. [ルートを変更する]チェックが ON の場合、[ルート入力]エリアを活性表示する
   3. [DB 同期]ボタン押下時、DB 同期処理を実行する。
2. **(APP)** DB 同期処理
   1. パラメータチェック。`root`が取得できない場合、エラー。
   2. パラメータに root が設定されている場合、`DB_INFO.root`パスを設定する。
   3. 検索処理を実行する。
   4. `save_dir`を比較し、`ILLUST_INFO`に登録があり`ILLUST_FETCH_WORK`に存在しない場合、配列に格納する。
   5. `ILLUST_FETCH_WORK`を truncate する。
   6. コミットを発行し、結果をクライアントに返却する。
3. **(画面)**
   1. 削除確認ダイアログを表示し、[はい]の場合、DB 整理処理を実行。
4. **(APP)** DB 整理処理
   1. DB から該当するエントリを削除する。
   2. コミットを発行し、結果をクライアントに返却する。

<!-------------------------------------------------------------------------->

## タグ検索画面

### タグ検索画面初期表示処理

1. タグを取得し、[タグプルダウン]を更新する。
2. キャラクター名を取得し、[キャラクター名プルダウン]を更新する。
3. 作者名を取得し、[作者名プルダウン]を更新する。
4. 検索履歴を取得し、[履歴プルダウン]を更新する。

### タグ検索機能

1. **(画面)** タグ検索画面
   1. [タグプルダウン]でタグを押下時、[検索条件部]に追加する。
   2. [検索条件部]の[マイナスボタン]を押下時、[検索条件部]から除外する。
   3. [条件スイッチ]で、AND 条件もしくは OR 条件を指定する。
   4. [検索]押下時、「タグ検索機能」を呼び出す。
2. **(APP)** タグ検索処理
   1. パラメータを基に SQL を作成し、ファイル情報を取得する。
   2. 検索条件と検索数を`SEARCH_HISTORY`に登録する。
   3. ファイル情報を返却する。
3. **(画面)** 成功後処理
   1. [結果ビュー]にサムネイルを一覧表示する。
   2. 検索履歴を取得し、[履歴プルダウン]を更新する。

### ファイル移動機能

1. **(画面)** ファイル移動ダイアログ
   1. [一括で移動する]チェックボックスの値を`move_accompany`に設定する。
2. **(APP)** ファイル移動処理
   1. `move_accompany`が true の場合、`ILLUST_INFO`の`illust_id`が一致し、`cnum`が一致するレコードの`save_dir`を更新する。
   2. 物理ファイルを移動する。
   3. コミットを発行し、結果をクライアントに返却する。
3. **(画面)** 成功後処理
   1. タグ検索処理を実行する。

### ファイル削除機能

1. **(画面)** ファイル削除ダイアログ
   1. [ファイル削除]ボタン押下時、選択したファイルをパラメータに[ファイル削除ダイアログ]を表示する。
   2. [ファイル削除ダイアログ]で[OK]押下時、ファイル削除を実行する。
2. **(APP)** ファイル削除処理
   1. `ILLUST_INFO`テーブルからパラメータ`illust_id`で検索し、`cnum`を取得する。
   2. `ILLUST_INFO`テーブルから該当レコードを削除。
   3. `ILLUST_INFO`テーブルからパラメータ`illust_id`、1 で取得した`cnum`で検索し、0 件の場合、`TAG_INFO`を削除する。
   4. 物理ファイルを削除する。
   5. コミットを発行し、結果をクライアントに返却する。
3. **(画面)** 成功後処理
   1. タグ検索処理を実行する。

### キャラクター名登録機能

1. **(画面)** 名前入力ダイアログ
   1. 初期表示時
      1. `CHARACTER_INFO`からキャラクター名を取得し、選択イラストのタグ情報とマージして、[名前登録]プルダウンに表示する。
   2. [紐づけ更新]チェックボックス
      1. [ON]の場合、`associate`を true に設定する。
      2. [OFF]の場合、`associate`を false に設定する。
   3. [ファイル移動]チェックボックス
      1. [ON]の場合、`move_file`を true に設定する。
      2. [OFF]の場合、`move_file`を false に設定する。
   4. [保存パス変更]チェックボックス
      1. [ON]の場合、[保存パス設定]エリアを活性にし、値に`collect_dir`を表示する。
      2. [OFF]の場合、[保存パス設定]エリアを非活性にし、値を空にする。
   5. [名前登録]プルダウンの値変更時、`CHARACTER_INFO`に一致するレコードの有無で以下処理。
      1. 登録がある場合、 [保存パス変更]チェックを OFF にする。
      2. 登録がない場合、[保存パス変更]チェックを ON にする。
   6. [OK]ボタン押下時
      1. [保存パス設定]エリアに設定された値を、`collect_dir`に格納する。
      2. 名前登録処理を実行する。
2. **(APP)** 名前登録処理
   1. `collect_dir`が設定されている場合、`CHARACTER_INFO`に入力情報を登録する。
   2. `ILLUST_INFO`を更新する。
      1. `associate`が true の場合、`illust_id`、`cnum`が同一の`character`を更新する。
      2. `associate`が false の場合、`cnum`をインクリメントして更新する。
      3. `move_file`が true の場合、`save_dir`を`collect_dir`に更新する。
   3. `TAG_INFO`を更新する。
      1. `associate`が false の場合、`TAG_INFO`を複製し、対象の`cnum`を更新する。
   4. `move_file`が true の場合、`collect_dir`に物理ファイルを移動する。
   5. コミットを発行し、結果をクライアントに返却する。
3. **(画面)** 成功後処理
   1. タグ検索処理を実行する。

## ファイル整理画面

### コレクト一覧表示機能

1. **(APP)** コレクト一覧取得処理
   1. `CHARACTER_INFO` から `series`, `character`, `collect_dir` をソートして取得する。
   2. `ILLUST_INFO`, `ILLUST_DETAIL` から `character` に紐づくレコード数をカウントする。
   3. 対象のファイルの `tag` が他の`series`, `character` と重複する場合は除外し、Uncollected 行でカウントする。
   4. `CHARACTER_INFO` の `character` と `series` を紐づけて、紐づけられた `character` の総数をカウントする。
   5. どれにも紐づかないレコード数を `Uncollecteds` に格納する。
2. **(画面)** ファイル整理画面
   1. 画面上の Series 列に series 配列、Character 列 に character 配列 をセットし、各項目に紐づくカウント数を表示。
   2. 末尾の Uncollecteds 行に`Uncollecteds`を表示する。

### 一括コレクト機能

1. **(画面)** ファイル整理画面
   1. Tags プルダウンから任意の tag を選択し、画面上の Series 列 または Character 列 に追加する。
   2. 一覧変更時、カウント処理を呼び出す。
   3. [コレクト]押下時、コレクト処理を実行する。
2. **(APP)** カウント処理
   1. 追加後の `series`, `character`をパラメータにしてコレクト一覧取得処理を呼び出す。
   2. 取得した値をアフターカウントに格納する。
3. **(APP)** コレクト実行処理
   1. `COLLECT_UI_WORK` と実際の DB の差分をチェックし、処理不要のレコードを削除する。
   2. `CHARACTER_INFO` に `COLLECT_UI_WORK` の `series`, `character` を追加し、
      root が設定されていれば、`CHARACTER_INFO.collect_dir` に {root}/series/character を設定する。
   3. `ILLUST_DETAIL` に `COLLECT_UI_WORK` の `series`, `character` を設定する。
   4. `ILLUST_INFO.save_dir` に {root}/series/character を設定する。
   5. {root}/series/character となるようにファイルを移動する。
   6. コミットを発行し、結果をクライアントに返却する。

### ルート設定機能

1. **(画面)**
   1. root が設定されていない場合、[ルートを変更する]チェックを ON にする。
   2. [ルートを変更する]チェックが ON の場合、[ルート入力]エリアを活性表示する
   3. [設定]ボタン押下時、ルート設定処理を実行する。
2. **(APP)** ルート設定処理
   1. `DB_INFO.root`に `root` を設定する。
   2. コミットを発行し、結果をクライアントに返却する。

## タグ管理画面

### タグ変換リスト機能

### タグ削除リスト機能

### タグ優先リスト機能

### タグ管理実行機能
